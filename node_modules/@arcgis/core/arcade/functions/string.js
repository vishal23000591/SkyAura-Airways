/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import t from"../ArcadePortal.js";import e from"../Attachment.js";import r from"../Dictionary.js";import{StringEnum as n}from"../enum.js";import{ArcadeExecutionError as a,ExecutionErrorCodes as o}from"../executionError.js";import{B as i,w as u,M as s,u as l,v as p,J as f,H as c,t as d,j as h,Y as y,K as g,Z as m,e as A,f as w,g as I,k as v,i as U,m as j,l as x}from"../../chunks/languageUtils.js";import{convertDirection as N}from"./convertdirection.js";import{XXH as k}from"./hash.js";import{hasSamePortal as C}from"../../core/urlUtils.js";import{generateUUID as P}from"../../core/uuid.js";import z from"../../geometry/Extent.js";import O from"../../geometry/Multipoint.js";import S from"../../geometry/Point.js";import F from"../../geometry/Polygon.js";import T from"../../geometry/Polyline.js";import L from"../../geometry/SpatialReference.js";import R from"../../portal/Portal.js";import{isArray as M,isString as H,isBoolean as b,isNumber as D}from"../../support/guards.js";function J(t){if("loaded"===t.loadStatus&&t.user?.sourceJSON){return t.user.sourceJSON}return null}function W(t,e){return!!t&&C(t,e?.restUrl||"")}function B(t,e){if(!t||!e)return t===e;if(t.x===e.x&&t.y===e.y){if(t.hasZ){if(t.z!==e.z)return!1}else if(e.hasZ)return!1;if(t.hasM){if(t.m!==e.m)return!1}else if(e.hasM)return!1;return!0}return!1}function Z(n,i,u){if(null!==n)if(M(n)){if(i.updateUint8Array([61]),u.map.has(n)){const t=u.map.get(n);i.updateIntArray([61237541^t])}else{u.map.set(n,u.currentLength++);for(const t of n)Z(t,i,u);u.map.delete(n),u.currentLength--}i.updateUint8Array([199])}else if(h(n)){if(i.updateUint8Array([61]),u.map.has(n)){const t=u.map.get(n);i.updateIntArray([61237541^t])}else{u.map.set(n,u.currentLength++);for(const t of n.toArray())Z(t,i,u);u.map.delete(n),u.currentLength--}i.updateUint8Array([199])}else{if(A(n))return i.updateIntArray([n.toNumber()]),void i.updateUint8Array([241]);if(w(n))return i.updateIntArray([n.toNumber()]),void i.updateIntArray([257]);if(I(n))return i.updateIntArray([n.toNumber()]),void i.updateIntArray([263]);if(H(n))return i.updateIntArray([n.length]),i.updateWithString(n),void i.updateUint8Array([41]);if(b(n))i.updateUint8Array([!0===n?1:0,113]);else{if(D(n))return i.updateFloatArray([n]),void i.updateUint8Array([173]);if(n instanceof e)throw new a(u.context,o.UnsupportedHashType,u.node);if(n instanceof t)throw new a(u.context,o.UnsupportedHashType,u.node);if(!(n instanceof r)){if(v(n))throw new a(u.context,o.UnsupportedHashType,u.node);if(n instanceof S)return i.updateIntArray([3833836621]),i.updateIntArray([0]),i.updateFloatArray([n.x]),i.updateIntArray([1]),i.updateFloatArray([n.y]),n.hasZ&&(i.updateIntArray([2]),i.updateFloatArray([n.z])),n.hasM&&(i.updateIntArray([3]),i.updateFloatArray([n.m])),i.updateIntArray([3765347959]),void Z(n.spatialReference.wkid,i,u);if(n instanceof F){i.updateIntArray([1266616829]);for(let t=0;t<n.rings.length;t++){const e=n.rings[t],r=[];let a=null,o=null;for(let i=0;i<e.length;i++){const u=n.getPoint(t,i);if(0===i)a=u;else if(B(o,u))continue;o=u,i===e.length-1&&B(a,u)||r.push(u)}i.updateIntArray([1397116793,r.length]);for(let t=0;t<r.length;t++){const e=r[t];i.updateIntArray([3962308117,t]),Z(e,i,u),i.updateIntArray([2716288009])}i.updateIntArray([2278822459])}return i.updateIntArray([3878477243]),void Z(n.spatialReference.wkid,i,u)}if(n instanceof T){i.updateIntArray([4106883559]);for(let t=0;t<n.paths.length;t++){const e=n.paths[t];i.updateIntArray([1397116793,e.length]);for(let r=0;r<e.length;r++)i.updateIntArray([3962308117,r]),Z(n.getPoint(t,r),i,u),i.updateIntArray([2716288009]);i.updateIntArray([2278822459])}return i.updateIntArray([2568784753]),void Z(n.spatialReference.wkid,i,u)}if(n instanceof O){i.updateIntArray([588535921,n.points.length]);for(let t=0;t<n.points.length;t++){const e=n.getPoint(t);i.updateIntArray([t]),Z(e,i,u)}return i.updateIntArray([1700171621]),void Z(n.spatialReference.wkid,i,u)}if(n instanceof z)return i.updateIntArray([3483648373]),i.updateIntArray([0]),i.updateFloatArray([n.xmax]),i.updateIntArray([1]),i.updateFloatArray([n.xmin]),i.updateIntArray([2]),i.updateFloatArray([n.ymax]),i.updateIntArray([3]),i.updateFloatArray([n.ymin]),n.hasZ&&(i.updateIntArray([4]),i.updateFloatArray([n.zmax]),i.updateIntArray([5]),i.updateFloatArray([n.zmin])),n.hasM&&(i.updateIntArray([6]),i.updateFloatArray([n.mmax]),i.updateIntArray([7]),i.updateFloatArray([n.mmin])),i.updateIntArray([3622027469]),void Z(n.spatialReference.wkid,i,u);if(n instanceof L)return i.updateIntArray([14]),void 0!==n.wkid&&null!==n.wkid&&i.updateIntArray([n.wkid]),n.wkt&&i.updateWithString(n.wkt),void(n.wkt2&&i.updateWithString(n.wkt2));if(U(n))throw new a(u.context,o.UnsupportedHashType,u.node);if(j(n))throw new a(u.context,o.UnsupportedHashType,u.node);if(x(n))throw new a(u.context,o.UnsupportedHashType,u.node);if(n===p)throw new a(u.context,o.UnsupportedHashType,u.node);throw new a(u.context,o.UnsupportedHashType,u.node)}if(i.updateUint8Array([223]),u.map.has(n)){const t=u.map.get(n);i.updateIntArray([61237541^t])}else{u.map.set(n,u.currentLength++);for(const t of n.keys()){i.updateIntArray([t.length]),i.updateWithString(t),i.updateUint8Array([251]);Z(n.field(t),i,u),i.updateUint8Array([239])}u.map.delete(n),u.currentLength--}i.updateUint8Array([73])}}else i.updateUint8Array([0,139])}function E(e,A){e.portal=function(e,r){return A(e,r,((n,a,o)=>(i(o,1,1,e,r),new t(u(o[0])))))},e.typeof=function(t,e){return A(t,e,((r,n,u)=>{i(u,1,1,t,e);const l=s(u[0]);if("Unrecognized Type"===l)throw new a(t,o.UnrecognizedType,e);return l}))},e.trim=function(t,e){return A(t,e,((r,n,a)=>(i(a,1,1,t,e),u(a[0]).trim())))},e.tohex=function(t,e){return A(t,e,((r,n,a)=>{i(a,1,1,t,e);const o=l(a[0]);return isNaN(o)?o:o.toString(16)}))},e.upper=function(t,e){return A(t,e,((r,n,a)=>(i(a,1,1,t,e),u(a[0]).toUpperCase())))};const w=new n(["every-word","first-word"]);e.proper=function(t,e){return A(t,e,((r,n,a)=>{i(a,1,2,t,e);const o=(a.length>=2?w.lookup(u(a[1])):null)??"every-word",s=/\s/,l=u(a[0]);let p="",f=!0;for(let t=0;t<l.length;t++){let e=l[t];if(s.test(e))"every-word"===o&&(f=!0);else{e.toUpperCase()!==e.toLowerCase()&&(f?(e=e.toUpperCase(),f=!1):e=e.toLowerCase())}p+=e}return p}))},e.lower=function(t,e){return A(t,e,((r,n,a)=>(i(a,1,1,t,e),u(a[0]).toLowerCase())))};const I=new n(["digits","digits-hyphen","digits-hyphen-braces","digits-hyphen-parentheses"]);e.guid=function(t,e){return A(t,e,((r,n,a)=>{i(a,0,1,t,e);switch(a.length>0?I.lookup(u(a[0])):null){case"digits":return P().replace("-","").replace("-","").replace("-","").replace("-","");case"digits-hyphen":return P();case"digits-hyphen-parentheses":return"("+P()+")";default:return"{"+P()+"}"}}))},e.standardizeguid=function(t,e){return A(t,e,((r,n,a)=>{i(a,2,2,t,e);let o=u(a[0]);if(""===o||null===o)return"";const s=/^(\{|\()?(?<partA>[0-9a-z]{8})(-?)(?<partB>[0-9a-z]{4})(-?)(?<partC>[0-9a-z]{4})(-?)(?<partD>[0-9a-z]{4})(-?)(?<partE>[0-9a-z]{12})(\}|\))?$/gim.exec(o);if(!s)return"";const l=s.groups;switch(o=l.partA+"-"+l.partB+"-"+l.partC+"-"+l.partD+"-"+l.partE,I.lookup(u(a[1]))){case"digits":return o.replace("-","").replace("-","").replace("-","").replace("-","");case"digits-hyphen":return o;case"digits-hyphen-parentheses":return"("+o+")";default:return"{"+o+"}"}}))},e.console=function(t,e){return A(t,e,((e,r,n)=>(0===n.length||(1===n.length?t.console(u(n[0])):t.console(u(n))),p)))},e.mid=function(t,e){return A(t,e,((r,n,a)=>{i(a,2,3,t,e);let o=l(a[1]);if(isNaN(o))return"";if(o=Math.max(0,o),2===a.length)return u(a[0]).slice(o);let s=l(a[2]);return isNaN(s)?"":(s<0&&(s=0),u(a[0]).slice(o,o+s))}))},e.find=function(t,e){return A(t,e,((r,n,a)=>{i(a,2,3,t,e);let o=0;if(a.length>2){if(o=l(f(a[2],0)),isNaN(o))return-1;o<0&&(o=0)}return u(a[1]).indexOf(u(a[0]),o)}))},e.left=function(t,e){return A(t,e,((r,n,a)=>{i(a,2,2,t,e);let o=l(a[1]);return isNaN(o)?"":(o<0&&(o=0),u(a[0]).slice(0,o))}))},e.right=function(t,e){return A(t,e,((r,n,a)=>{i(a,2,2,t,e);const o=l(a[1]);if(isNaN(o)||o<=0)return"";return u(a[0]).slice(-o)}))},e.split=function(t,e){return A(t,e,((r,n,a)=>{let o;i(a,2,4,t,e);let s=l(f(a[2],-1));const p=c(f(a[3],!1));if(-1===s||null===s||!0===p?o=u(a[0]).split(u(a[1])):(isNaN(s)&&(s=-1),s<-1&&(s=-1),o=u(a[0]).split(u(a[1]),s)),!1===p)return o;const d=[];for(let t=0;t<o.length&&!(-1!==s&&d.length>=s);t++)""!==o[t]&&void 0!==o[t]&&d.push(o[t]);return d}))},e.text=function(t,e){return A(t,e,((r,n,a)=>(i(a,1,2,t,e),d(a[0],a[1]))))},e.concatenate=function(t,e){return A(t,e,((t,e,r)=>{const n=[];if(r.length<1)return"";if(M(r[0])){const t=f(r[2],"");for(let e=0;e<r[0].length;e++)n[e]=d(r[0][e],t);return r.length>1?n.join(r[1]):n.join("")}if(h(r[0])){const t=f(r[2],"");for(let e=0;e<r[0].length();e++)n[e]=d(r[0].get(e),t);return r.length>1?n.join(r[1]):n.join("")}for(let a=0;a<r.length;a++)n[a]=d(r[a]);return n.join("")}))},e.reverse=function(t,e){return A(t,e,((r,n,u)=>{if(i(u,1,1,t,e),M(u[0])){const t=u[0].slice();return t.reverse(),t}if(h(u[0])){const t=u[0].toArray().slice();return t.reverse(),t}throw new a(t,o.InvalidParameter,e)}))},e.replace=function(t,e){return A(t,e,((r,n,a)=>{i(a,3,4,t,e);const o=u(a[0]),s=u(a[1]),l=u(a[2]);return 4!==a.length||c(a[3])?y(o,s,l):o.replace(s,l)}))},e.urlencode=function(t,e){return A(t,e,((n,a,o)=>{if(i(o,1,1,t,e),null===o[0])return"";if(o[0]instanceof r){let t="";for(const e of o[0].keys()){const r=o[0].field(e);""!==t&&(t+="&"),t+=null===r?encodeURIComponent(e)+"=":encodeURIComponent(e)+"="+encodeURIComponent(r)}return t}return encodeURIComponent(u(o[0]))}))},e.hash=function(t,e){return A(t,e,((r,n,a)=>{i(a,1,1,t,e);const o=new k(0);return Z(a[0],o,{context:t,node:e,map:new Map,currentLength:0}),o.digest()}))},e.convertdirection=function(t,e){return A(t,e,((r,n,a)=>(i(a,3,3,t,e),N(a[0],a[1],a[2]))))},e.fromjson=function(t,e){return A(t,e,((n,s,l)=>{if(i(l,1,1,t,e),!1===H(l[0]))throw new a(t,o.InvalidParameter,e);return r.convertJsonToArcade(JSON.parse(u(l[0])),g(t))}))},e.tocharcode=function(t,e){return A(t,e,((r,n,s)=>{i(s,1,2,t,e);const p=l(f(s[1],0)),c=u(s[0]);if(0===c.length&&1===s.length)return null;if(c.length<=p||p<0)throw new a(t,o.OutOfBounds,e);return c.charCodeAt(p)}))},e.tocodepoint=function(t,e){return A(t,e,((r,n,s)=>{i(s,1,2,t,e);const p=l(f(s[1],0)),c=u(s[0]);if(0===c.length&&1===s.length)return null;if(c.length<=p||p<0)throw new a(t,o.OutOfBounds,e);return c.codePointAt(p)}))},e.fromcharcode=function(t,e){return A(t,e,((r,n,i)=>{if(i.length<1)throw new a(t,o.WrongNumberOfParameters,e);const u=i.map((t=>Math.trunc(l(t)))).filter((t=>t>=0&&t<=65535));return 0===u.length?null:String.fromCharCode.apply(null,u)}))},e.fromcodepoint=function(t,e){return A(t,e,((r,n,i)=>{if(i.length<1)throw new a(t,o.WrongNumberOfParameters,e);let u;try{u=i.map((t=>Math.trunc(l(t)))).filter((t=>t<=1114111&&t>>>0===t))}catch(s){return null}return 0===u.length?null:String.fromCodePoint.apply(null,u)}))},e.getuser=function(e,n){return A(e,n,((s,l,p)=>{i(p,0,2,e,n);let c=f(p[1],"");if(c=!0===c||!1===c?"":u(c),null!==c&&""!==c)return null;if(0===p.length||p[0]instanceof t){let t=null;if(t=e.services?.portal?e.services.portal:R.getDefault(),p.length>0){if(!W(p[0].field("url"),t))return null}if(!t)return null;if(""===c){const n=J(t);if(n){const t=JSON.parse(JSON.stringify(n));for(const e of["lastLogin","created","modified"])void 0!==t[e]&&null!==t[e]&&(t[e]=new Date(t[e]));return r.convertObjectToArcadeDictionary(t,g(e))}}return null}throw new a(e,o.InvalidParameter,n)}))},e.getenvironment=function(t,e){return A(t,e,((n,a,o)=>(i(o,0,0,t,e),r.convertObjectToArcadeDictionary(m(g(t),t.spatialReference),g(t),!0))))},e.standardizefilename=function(t,e){return A(t,e,((t,e,r)=>{i(r,1,1,t,e);const[n]=r;if(null==n)return"";if(!H(n))throw new a(t,o.InvalidParameter,e);return n.replaceAll(/[<>"?*]/g,"_").replaceAll(/[/\\|]/g,"-").replaceAll(":",", ")}))}}export{E as registerFunctions};
