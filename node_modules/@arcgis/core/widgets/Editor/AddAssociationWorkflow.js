/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Error.js";import{makeHandle as i,abortHandle as o}from"../../core/handleUtils.js";import{isAborted as s}from"../../core/promiseUtils.js";import{watch as r}from"../../core/reactiveUtils.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/RandomLCG.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import{isSubtypeSublayer as l}from"../../layers/support/layerUtils.js";import{createFeatureServices as d}from"../../rest/featureService/utils.js";import c from"../../views/draw/support/HighlightHelper.js";import{temporaryHighlightName as u}from"../../views/support/HighlightDefaults.js";import p from"./AddAssociationWorkflowData.js";import w from"./Workflow.js";import{fetchFullFeatures as h}from"./workflowUtils.js";import y from"../FeatureForm/UtilityNetworkAssociationAddAssociationViewModel.js";import{getFeatureTitle as m}from"../support/UtilityNetworkAssociations/utils/getFeatureTitle.js";var A;const f={exit:Symbol()};let g=class extends w{static{A=this}constructor(e){super(e),this._utilityNetworkAssociationAddAssociationViewModel=new y,this._highlightHelper=null,this.sourceFeatureItem=null,this.type="add-association"}initialize(){const{data:e}=this,{view:t}=e.viewModel;t&&(this._highlightHelper=new c({view:t,highlightName:u}),this.addHandles(i((()=>this._highlightHelper?.removeAll()))));const s=new AbortController;this.addHandles(o(s)),this._updatingHandles.addPromise(this._setup(s))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get utilityNetworkAssociationAddAssociationViewModel(){return this._utilityNetworkAssociationAddAssociationViewModel}get hasPendingEdits(){return!!this._utilityNetworkAssociationAddAssociationViewModel.selectedFeature}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get reliesOnOwnerAdminPrivileges(){return this.editorItem.capabilities.create.reliesOnOwnerAdminPrivileges}async enter(){this._addHandles()}exit(){this.removeHandles(f.exit)}async start(){return await super.start(),null}async _setup(e){const{data:i}=this,{feature:o}=i;try{const[t]=await h([o],o.sourceLayer,i.viewModel.view.spatialReference,e.signal);if(s(e))return;const r=t.sourceLayer&&"getFeatureTitle"in t.sourceLayer?await t.sourceLayer.getFeatureTitle(t):m(t);if(s(e))return;this.sourceFeatureItem={feature:o,label:r},this._initializeUtilityNetworkAssociationAddAssociationViewModel()}catch(r){this.cancel({force:!0,error:new t("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:r}})})}}_initializeUtilityNetworkAssociationAddAssociationViewModel(){const{viewModel:{view:e},utilityNetwork:t,associationType:i}=this.data,o=this._utilityNetworkAssociationAddAssociationViewModel;o.graphic=this.sourceFeatureItem.feature,o.map=e?.map,o.utilityNetwork=t,o.layer=this.layer,o.associationType=i,o.highlightHelper=this._highlightHelper,t.networkSystemLayers.loadAssociationsTable()}_addHandles(){const e=this._utilityNetworkAssociationAddAssociationViewModel;this.addHandles([r((()=>e.selectedLayer),(e=>{e&&this.go("add-association-select-feature")})),r((()=>e.selectedFeature),(e=>{e&&this.go("add-association-create-association")}))],f.exit)}static async create(e){const t=new A({data:await p.create(e),onCommit:this._onCommitFactory(e.applyEditsFeatureService)});return t._set("steps",this._createWorkflowSteps(t)),t}static _createWorkflowSteps(e){return[{id:"add-association-select-layer",async setUp(){const{utilityNetworkAssociationAddAssociationViewModel:t}=e.data.viewModel;t&&(t.selectedLayer=null,t.selectedFeature=null,t.association=null)},async tearDown(){}},{id:"add-association-select-feature",async setUp(){const{utilityNetworkAssociationAddAssociationViewModel:t}=e.data.viewModel;t&&(t.selectedFeature=null,t.association=null)},async tearDown(){}},{id:"add-association-create-association",async setUp(){},async tearDown(){}}]}static{this._onCommitFactory=e=>async i=>{const{feature:o,utilityNetwork:s,associationInput:r}=i,{utilityNetworkAssociationAddAssociationViewModel:a}=i.viewModel,{association:n}=a;await s.networkSystemLayers.loadAssociationsTable();const c=s?.generateAddAssociations([n]);if(!c)throw new t("editor:failed-to-add-association","Could not create payload needed to add association");const u=o.sourceLayer,p=l(u)&&u.parent?u.parent:u,w=d([p]),h=w.values().next().value?.featureService;if(!h)throw new t("editor:failed-to-delete-association","Could not retrieve feature service needed to delete association");await(h?.load());const y=s?.gdbVersion??void 0;await e(h,[c],{gdbVersion:y}),await r.refresh()}}};e([a()],g.prototype,"_utilityNetworkAssociationAddAssociationViewModel",void 0),e([a()],g.prototype,"_featureFormViewModel",void 0),e([a()],g.prototype,"editorItem",null),e([a()],g.prototype,"featureFormViewModel",null),e([a()],g.prototype,"utilityNetworkAssociationAddAssociationViewModel",null),e([a()],g.prototype,"sourceFeatureItem",void 0),e([a()],g.prototype,"hasPendingEdits",null),e([a()],g.prototype,"layer",null),e([a()],g.prototype,"parent",null),e([a()],g.prototype,"parentLayer",null),e([a()],g.prototype,"reliesOnOwnerAdminPrivileges",null),g=A=e([n("esri.widgets.Editor.AddAssociationWorkflow")],g);export{g as AddAssociationWorkflow};
