/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import s from"../../core/Error.js";import{isTimeOnlyField as i,numericTypes as r}from"../../layers/support/fieldUtils.js";import{verifyBasicFieldValidity as t,verifyFieldType as e,verifyFilterValidity as a}from"./support/utils.js";import{verifyBinningParams as n}from"../support/binningUtils.js";import{getNormalizationType as o,getFieldsList as l,isAnyDateField as p,dateTypes as m}from"../support/utils.js";import{defaultSupportedLayerTypes as u,LayerType as f,binningCapableLayerTypes as d,createLayerAdapter as c,getLayerTypeLabels as y}from"../support/adapters/support/layerUtils.js";const w=[...r,...m,"time-only","string"];async function v(r){if(!r?.layer||!(r.field||r.valueExpression||r.sqlExpression))throw new s("summary-statistics:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(r.valueExpression&&!r.sqlExpression&&!r.view)throw new s("summary-statistics:missing-parameters","View is required when 'valueExpression' is specified");r.forBinning&&n(r,"summary-statistics");const{layer:m,...v}=r,x=[...u,f.ImageryLayer],E=r.forBinning?d:x,h=c(m,E,r.forBinning);if(!h)throw new s("summary-statistics:invalid-parameters","'layer' must be one of these types: "+y(E).join(", "));const g={layerAdapter:h,...v};g.normalizationType=o(g);const j=null!=g.signal?{signal:g.signal}:null;await h.load(j);const q=g.field,z=g.normalizationType,B=g.valueExpression||g.sqlExpression,F=q?h.getField(q):null,U=await l({field:g.field,normalizationField:g.normalizationField,valueExpression:g.valueExpression}),b=t(h,U,"summary-statistics:invalid-parameters");if(b)throw b;if(F){const r=e(h,F,"summary-statistics:invalid-parameters",w);if(r)throw r;if((p(F)||i(F))&&z)throw new s("summary-statistics:invalid-parameters","Normalization is not allowed for date fields")}else if(B&&z)throw new s("summary-statistics:invalid-parameters","Normalization is not allowed when 'valueExpression' or 'sqlExpression' is specified");g.filter&&!g.filter.spatialRelationship&&(g.filter.spatialRelationship="intersects");const A=a(g.filter,"summary-statistics:invalid-parameters");if(A)throw A;return g}async function x(s){const{layerAdapter:i,...r}=await v(s);return i.summaryStatistics(r)}export{x as default};
