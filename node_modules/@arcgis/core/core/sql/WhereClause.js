/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import has from"../has.js";import{isAggregate as e,aggregateFunction as t}from"./AggregateFunctions.js";import{DateOnly as r}from"./DateOnly.js";import{SqlError as a,SqlErrorCodes as s}from"./errorSupport.js";import{sqlCalculateFunction as n}from"./sqlArithmeticUtils.js";import{sqlCompare as i,isDateOrTimeValue as o}from"./sqlCompareUtils.js";import{isDateTime as u,isTimestampOffset as l,isTimeOnly as c,isDateOnly as p,parseTime as m,parseTimestamp as h,parseDate as d,convertToExecutingTimeZone as f}from"./sqlDateParsingUtils.js";import{SqlInterval as _}from"./SqlInterval.js";import{SqlTimeStampOffset as N}from"./SqlTimestampOffset.js";import{evaluateFunction as v,isStandardized as g}from"./StandardizedFunctions.js";import{TimeOnly as y}from"./TimeOnly.js";import{WhereGrammar as S,visitAll as T}from"./WhereGrammar.js";import{isDate as w}from"../../support/guards.js";import{DateTime as D,FixedOffsetZone as I}from"luxon";const x=new Set(["current_timestamp","current_date","current_time"]);class E{constructor(e){this.staticData=e}makeBool(e){return Z(e)}featureValue(e,t,r,a){return te(e,t,r,a)}equalsNull(e){return null===e}applyLike(e,t,r){return Y(e,t,r)}ensureArray(e){return z(e)}applyIn(e,t){return W(e,t)}currentTimestamp(e){return G(e)}currentDate(e){return K(e)}currentTime(e){return Q(e)}makeSqlInterval(e,t,r){return _.createFromValueAndQualifier(e,t,r)}convertInterval(e){return _.isInterval(e)?e.valueInMilliseconds():e}compare(e,t,r){return i(t,r,e)}calculate(e,t,r,a){return n(e,t,r,a)}evaluateTime(e){return m(e)}evaluateTimestamp(e,t,r){return h(e,t,r)}evaluateDate(e,t){return d(e,t)}evaluateFunction(e,t,r){return v(e,t,r)}lookup(e,t){const r=t[e];return void 0===r?null:r}between(e,t){return null==e||null==t[0]||null==t[1]?null:i(e,t[0],">=")&&i(e,t[1],"<=")}notbetween(e,t){return null==e||null==t[0]||null==t[1]?null:i(e,t[0],"<")||i(e,t[1],">")}ternaryNot(e){return J(e)}ternaryAnd(e,t){return B(e,t)}ternaryOr(e,t){return M(e,t)}}function $(e,...t){return`this.${e}(${t.join(", ")})`}function F(e){return void 0===e?"void 0":JSON.stringify(e)}function b({type:e,start:t,end:r}){return`{type: ${F(e)}, start: ${A(t)}, end: ${A(r)}}`}function A({type:e,period:t,precision:r,secondary:a}){return JSON.stringify({type:e,period:t,precision:r,secondary:a})}function O({type:e,size:t,withtimezone:r}){return JSON.stringify({type:e,size:t,withtimezone:r})}const k="feature",U="lookups",V="attributeAdapter",j="fieldsIndex",q="timeZone",C="currentUser";class L{constructor(e){this._parseTree=e,this._staticData=Object.create(null),this._nextStaticDataId=0,this._tempVars=new Set,this._nextTempVarId=0}compile(){const e=this._compileNode(this._parseTree),t=`\n      ${this._tempVars.size>0?`var ${Array.from(this._tempVars).join(", ")};`:""}\n      return this.convertInterval(${e});\n    `;return new Function(k,U,V,j,q,C,t).bind(new E(this._staticData))}_storeStaticData(e){const t="static$"+this._nextStaticDataId++;return this._staticData[t]=e,t}_compileRefStaticData(e){return`this.staticData[${F(e)}]`}_generateTempVar(){const e="temp$"+this._nextTempVarId++;return this._tempVars.add(e),e}_compileSimpleCase(e){const t=this._compileNode(e.operand),r=this._generateTempVar(),a=[];for(const s of e.clauses){const e=$("compare",F("="),r,this._compileNode(s.operand)),t=this._compileNode(s.value);a.push(`${e} ? (${t}) :`)}return null!=e.else?a.push(this._compileNode(e.else)):a.push(F(null)),`(${r} = ${t}, ${a.join(" ")})`}_compileSearchedCase(e){const t=[];for(const r of e.clauses){const e=$("makeBool",this._compileNode(r.operand)),a=this._compileNode(r.value);t.push(`${e} ? (${a}) :`)}return null!=e.else?t.push(this._compileNode(e.else)):t.push(F(null)),t.join(" ")}_compileInExpr(e,t){const r=new Set,a=[];for(const i of t.value)"number"===i.type||"string"===i.type?r.add(i.value):a.push(i);const s=this._compileNode(e),n=$("ensureArray",this._compileNode({type:"expression-list",location:t.location,value:a}));if(r.size>0){const e=this._compileRefStaticData(this._storeStaticData(r)),t=this._generateTempVar();return a.length>0?`(${t} = ${s}, ${e}.has(${t}) || ${$("applyIn",t,n)})`:`(${t} = ${s}, ${t} == null ? null : ${e}.has(${t}))`}return $("applyIn",s,n)}_compileNode(e){switch(e.type){case"interval":return $("makeSqlInterval",this._compileNode(e.value),"interval-qualifier"===e.qualifier.type?b(e.qualifier):A(e.qualifier),F(e.op));case"case-expression":return"simple"===e.format?this._compileSimpleCase(e):this._compileSearchedCase(e);case"parameter":return $("lookup",F(e.value.toLowerCase()),U);case"expression-list":return`[${e.value.map((e=>this._compileNode(e))).join(", ")}]`;case"unary-expression":return $("ternaryNot",this._compileNode(e.expr));case"binary-expression":switch(e.operator){case"AND":return $("ternaryAnd",this._compileNode(e.left),this._compileNode(e.right));case"OR":return $("ternaryOr",this._compileNode(e.left),this._compileNode(e.right));case"IS":if("null"!==e.right.type)throw new a(s.UnsupportedIsRhs);return $("equalsNull",this._compileNode(e.left));case"ISNOT":if("null"!==e.right.type)throw new a(s.UnsupportedIsRhs);return`!${$("equalsNull",this._compileNode(e.left))}`;case"IN":return this._compileInExpr(e.left,e.right);case"NOT IN":return $("ternaryNot",this._compileInExpr(e.left,e.right));case"BETWEEN":return $("between",this._compileNode(e.left),this._compileNode(e.right));case"NOTBETWEEN":return $("notbetween",this._compileNode(e.left),this._compileNode(e.right));case"LIKE":return $("applyLike",this._compileNode(e.left),this._compileNode(e.right),F(e.escape));case"NOT LIKE":return $("ternaryNot",$("applyLike",this._compileNode(e.left),this._compileNode(e.right),F(e.escape)));case"<>":case"<":case">":case">=":case"<=":case"=":return $("compare",F(e.operator),this._compileNode(e.left),this._compileNode(e.right));case"*":case"-":case"+":case"/":case"||":return $("calculate",F(e.operator),this._compileNode(e.left),this._compileNode(e.right),q);default:throw new a(s.UnsupportedOperator,{operator:e.operator})}case"null":case"boolean":case"string":case"number":return F(e.value);case"time":try{return this._compileRefStaticData(this._storeStaticData(m(e.value)))}catch{return $("evaluateTime",F(e.value))}case"date":try{return this._compileRefStaticData(this._storeStaticData(d(e.value,"unknown")))}catch{return $("evaluateDate",F(e.value),F("unknown"))}case"timestamp":try{return this._compileRefStaticData(this._storeStaticData(h(e.value,"unknown")))}catch{return $("evaluateTimestamp",F(e.value),F("unknown"))}case"current-time":return"date"===e.mode?$("currentDate",q):"time"===e.mode?$("currentTime",q):$("currentTimestamp",q);case"current-user":return C;case"column-reference":return $("featureValue",k,F(e.column),j,V);case"data-type":return O(e.value);case"function":return $("evaluateFunction",F(e.name),this._compileNode(e.args),q)}throw new a(s.UnsupportedSyntax,{node:e.type})}}class R{static create(e,t={}){return new R(e,t.fieldsIndex,t.timeZone??void 0,t.currentUser)}constructor(e,t,r="UTC",a=null){this.fieldsIndex=t,this.timeZone=r,this.currentUser=a,this.parameters={},this._compiledExecutor=null,this._hasDateFunctions=void 0,this.parseTree=S.parse(e);const{isStandardized:s,isAggregate:n,currentUserRequired:i,referencedFieldNames:o}=this._extractExpressionInfo(t);this._referencedFieldNames=o,this.isStandardized=s,this.isAggregate=n,this.currentUserRequired=i}static convertValueToStorageFormat(e,t=null){if(null===t)return w(e)?e.getTime():u(e)?e.toMillis():l(e)?e.toStorageFormat():c(e)?e.toStorageString():p(e)?e.toStorageFormat():e;switch(t){case"date":return w(e)?e.getTime():u(e)?e.toMillis():l(e)?e.toMilliseconds():p(e)?e.toNumber():e;case"date-only":return w(e)?r.fromDateJS(e).toString():l(e)?r.fromSqlTimeStampOffset(e).toString():u(e)?r.fromDateTime(e).toString():e;case"time-only":return w(e)?y.fromDateJS(e).toStorageString():u(e)?y.fromDateTime(e).toStorageString():l(e)?y.fromSqlTimeStampOffset(e).toStorageString():c(e)?e.toStorageString():e;case"timestamp-offset":if(w(e))return N.fromJSDate(e).toStorageFormat();if(u(e))return N.fromDateTime(e).toStorageFormat();if(l(e))return e.toStorageFormat()}return e}get fieldNames(){return this._referencedFieldNames}testSet(e,t=re,r=this.currentUser){return!!this._evaluateNode(this.parseTree,null,t,e,r)}calculateValue(e,t=re,r=this.currentUser){const a=this._evaluateNode(this.parseTree,e,t,null,r);return _.isInterval(a)?a.valueInMilliseconds()/864e5:a}tryGetCompiledExecutor(){if(null!=this._compiledExecutor)return this._compiledExecutor;if(has("esri-csp-restrictions"))return null;const e=new L(this.parseTree);return this._compiledExecutor=e.compile(),this._compiledExecutor}calculateValueCompiled(e,t=re,r=this.currentUser){const a=this.tryGetCompiledExecutor();return null==a?this.calculateValue(e,t):a(e,this.parameters,t,this.fieldsIndex,this.timeZone,r??null)}testFeature(e,t=re,r=this.currentUser){return!!this._evaluateNode(this.parseTree,e,t,null,r)}testFeatureCompiled(e,t=re,r=this.currentUser){const a=this.tryGetCompiledExecutor();return null==a?this.testFeature(e,t):!!a(e,this.parameters,t,this.fieldsIndex,this.timeZone,r??null)}get hasDateFunctions(){return null!=this._hasDateFunctions||(this._hasDateFunctions=!1,T(this.parseTree,(e=>{"current-time"===e.type?this._hasDateFunctions=!0:"function"===e.type&&(this._hasDateFunctions=this._hasDateFunctions||x.has(e.name.toLowerCase()))}))),this._hasDateFunctions}getFunctions(){const e=new Set;return T(this.parseTree,(t=>{"function"===t.type&&e.add(t.name.toLowerCase())})),Array.from(e)}getExpressions(){const e=new Map;return T(this.parseTree,(t=>{if("function"===t.type){const r=t.name.toLowerCase(),a=t.args.value[0];if("column-reference"===a.type){const t=a.column,s=`${r}-${t}`;e.has(s)||e.set(s,{aggregateType:r,field:t})}}})),[...e.values()]}getVariables(){const e=new Set;return T(this.parseTree,(t=>{"parameter"===t.type&&e.add(t.value.toLowerCase())})),Array.from(e)}_extractExpressionInfo(t){const r=[],a=new Set;let s=!0,n=!1,i=!1;return T(this.parseTree,(o=>{switch(o.type){case"column-reference":{const e=t?.get(o.column);let s,n;e?s=n=e.name??"":(n=o.column,s=n.toLowerCase()),a.has(s)||(a.add(s),r.push(n)),o.column=n;break}case"current-user":i=!0;break;case"function":{const{name:t,args:r}=o,a=r.value.length;s&&(s=g(t,a)),!1===n&&(n=e(t,a));break}}})),{referencedFieldNames:Array.from(r),isStandardized:s,isAggregate:n,currentUserRequired:i}}_evaluateNode(r,o,u,l,c){let p;switch(r.type){case"interval":{const e=this._evaluateNode(r.value,o,u,l,c);return _.createFromValueAndQualifier(e,r.qualifier,r.op)}case"case-expression":if("simple"===r.format){const e=this._evaluateNode(r.operand,o,u,l,c);for(let t=0;t<r.clauses.length;t++)if(i(e,this._evaluateNode(r.clauses[t].operand,o,u,l,c),"="))return this._evaluateNode(r.clauses[t].value,o,u,l,c);if(null!==r.else)return this._evaluateNode(r.else,o,u,l,c)}else{for(let e=0;e<r.clauses.length;e++)if(Z(this._evaluateNode(r.clauses[e].operand,o,u,l,c)))return this._evaluateNode(r.clauses[e].value,o,u,l,c);if(null!==r.else)return this._evaluateNode(r.else,o,u,l,c)}return null;case"parameter":return p=this.parameters[r.value.toLowerCase()],w(p)?D.fromJSDate(p):null!=p&&"object"==typeof p&&"toDateTime"in p?p.toDateTime():p;case"expression-list":{const e=[];for(const t of r.value)e.push(this._evaluateNode(t,o,u,l,c));return e}case"unary-expression":return J(this._evaluateNode(r.expr,o,u,l,c));case"binary-expression":switch(r.operator){case"AND":return B(this._evaluateNode(r.left,o,u,l,c),this._evaluateNode(r.right,o,u,l,c));case"OR":return M(this._evaluateNode(r.left,o,u,l,c),this._evaluateNode(r.right,o,u,l,c));case"IS":if("null"!==r.right.type)throw new a(s.UnsupportedIsRhs);return null===this._evaluateNode(r.left,o,u,l,c);case"ISNOT":if("null"!==r.right.type)throw new a(s.UnsupportedIsRhs);return null!==this._evaluateNode(r.left,o,u,l,c);case"IN":{const e=z(this._evaluateNode(r.right,o,u,l,c));return W(this._evaluateNode(r.left,o,u,l,c),e)}case"NOT IN":{const e=z(this._evaluateNode(r.right,o,u,l,c));return J(W(this._evaluateNode(r.left,o,u,l,c),e))}case"BETWEEN":{const e=this._evaluateNode(r.left,o,u,l,c),t=this._evaluateNode(r.right,o,u,l,c);return null==e||null==t[0]||null==t[1]?null:i(e,t[0],">=")&&i(e,t[1],"<=")}case"NOTBETWEEN":{const e=this._evaluateNode(r.left,o,u,l,c),t=this._evaluateNode(r.right,o,u,l,c);return null==e||null==t[0]||null==t[1]?null:i(e,t[0],"<")||i(e,t[1],">")}case"LIKE":return Y(this._evaluateNode(r.left,o,u,l,c),this._evaluateNode(r.right,o,u,l,c),r.escape);case"NOT LIKE":return J(Y(this._evaluateNode(r.left,o,u,l,c),this._evaluateNode(r.right,o,u,l,c),r.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return i(this._evaluateNode(r.left,o,u,l,c),this._evaluateNode(r.right,o,u,l,c),r.operator);case"-":case"+":case"*":case"/":case"||":return n(r.operator,this._evaluateNode(r.left,o,u,l,c),this._evaluateNode(r.right,o,u,l,c),this.timeZone)}case"null":case"boolean":case"string":case"number":return r.value;case"date":return r.parsedValue??=d(r.value,"unknown"),r.parsedValue;case"timestamp":return r.parsedValue??=h(r.value,"unknown"),r.parsedValue;case"time":return m(r.value);case"current-time":return"date"===r.mode?K(this.timeZone):"time"===r.mode?Q(this.timeZone):G(this.timeZone);case"current-user":return c??null;case"column-reference":return te(o,r.column,this.fieldsIndex,u);case"data-type":return r.value;case"function":{if(this.isAggregate&&e(r.name,r.args.value.length)){const e=[];for(const t of r.args?.value||[]){const r=[];for(const e of l||[])r.push(this._evaluateNode(t,e,u,null,c));e.push(r)}return t(r.name,e)}const a=this._evaluateNode(r.args,o,u,l,c);return v(r.name,a,this.timeZone)}}throw new a(s.UnsupportedSyntax,{node:r.type})}}function Z(e){return!0===e}function z(e){return Array.isArray(e)?e:[e]}function J(e){return null!==e?!0!==e:null}function B(e,t){return null!=e&&null!=t?!0===e&&!0===t:!1!==e&&!1!==t&&null}function M(e,t){return null!=e&&null!=t?!0===e||!0===t:!0===e||!0===t||null}function W(e,t){if(null==e)return null;let r=!1;for(const a of t)if(null==a)r=null;else{if(e===a){r=!0;break}if(o(e)&&o(a)&&(r=i(e,a,"="),r))break}return r}function G(e){return f(new Date,e)}function K(e){return r.fromNow(e)}function Q(e){const t=f(new Date,e);return y.fromDateTime(t)}const P="-[]/{}()*+?.\\^$|";var H;function X(e,t){const r=t;let a="",s=H.Normal;for(let n=0;n<e.length;n++){const t=e.charAt(n);switch(s){case H.Normal:t===r?s=H.Escaped:P.includes(t)?a+="\\"+t:a+="%"===t?".*":"_"===t?".":t;break;case H.Escaped:P.includes(t)?a+="\\"+t:a+=t,s=H.Normal}}return new RegExp("^"+a+"$","m")}function Y(e,t,r){if(null==e)return null;return X(t,r).test(e)}function ee(e){return e&&"object"==typeof e.attributes}function te(e,t,a,s){if("getAttributeSQL"in s)return s.getAttributeSQL(e,t);const n=s.getAttribute(e,t);if(null==n)return n;const i=a?.get(t);switch(i?.type){case"esriFieldTypeDate":case"date":return f(new Date(n),a?.getLuxonTimeZone(i.name)??I.utcInstance);case"esriFieldTypeDateOnly":case"date-only":return r.fromReader(n);case"esriFieldTypeTimeOnly":case"time-only":return y.fromReader(n);case"esriFieldTypeTimestampOffset":case"timestamp-offset":return new N(n)}return n}!function(e){e[e.Normal=0]="Normal",e[e.Escaped=1]="Escaped"}(H||(H={}));const re={getAttribute:(e,t)=>(ee(e)?e.attributes:e)[t]};export{R as default};
