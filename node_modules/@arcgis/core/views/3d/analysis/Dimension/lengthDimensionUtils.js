/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{LengthDimensionMeasureType as e}from"../../../../analysis/dimensionUtils.js";import{deg2rad as t}from"../../../../core/mathUtils.js";import{toUnit as n}from"../../../../core/quantityUtils.js";import{adaptiveVerticalLengthUnit as r,adaptiveLengthUnit as i}from"../../../../core/unitUtils.js";import{ensureType as o}from"../../../../core/accessorSupport/ensureType.js";import{fromRotation as a}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{create as s}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{c as d,k as c,b as l,t as u,a as p,h as m,e as S,G as g,n as f,x as v}from"../../../../chunks/vec32.js";import{create as R,ZEROS as A}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import P from"../../../../geometry/Point.js";import{Axis as y}from"../../../../geometry/support/Axis.js";import{sv3d as h}from"../../../../geometry/support/vectorStacks.js";import{makeDehydratedPoint as j}from"../../../../layers/graphics/dehydratedPoint.js";import{clonePoint as E}from"../../../../layers/graphics/hydratedFeatures.js";import{EuclideanSegment as x}from"../../interactive/visualElements/support/Segment.js";import{euclideanDirectDistanceBetweenPoints as w,euclideanDirectDistance as z}from"../../../support/euclideanLengthMeasurementUtils.js";import{geodesicDistanceThreshold as U}from"../../../support/geodesicMeasurementUtils.js";class b{constructor(e,t,n,r,i,o){this.elevationAlignedStartPoint=e,this.elevationAlignedEndPoint=t,this.directSegment=n,this.dimensionSegment=r,this.primaryOffsetAxis=i,this.spatialReference=o}}const H=o(P);function T(t,o,a,s){if(null==t)return null;let d;if(o===e.Horizontal)d=s.autoDistanceBetweenPoints2D(H(t.elevationAlignedStartPoint),H(t.elevationAlignedEndPoint));else{const{startRenderSpace:e,endRenderSpace:n}=t.dimensionSegment;d=z(e,n,t.spatialReference)}if(null==d)return null;const c=o===e.Vertical?r(d.value,d.unit,a):i(d.value,d.unit,a);return n(d,c)}function C(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:n,dimension:{offset:r,measureType:i,orientation:o}}=e;return{elevationAlignedStartPoint:t,elevationAlignedEndPoint:n,offset:r,measureType:i,orientation:o}}function k({elevationAlignedStartPoint:t,elevationAlignedEndPoint:n,offset:r,measureType:i,orientation:o},a,s=null){if(null==t||null==n)return null;const c=B(s?.directSegment??new x,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:n},a),l=s?.primaryOffsetAxis??R();Y(l,{measureType:i,elevationAlignedStartPoint:t,elevationAlignedEndPoint:n,directSegment:c,orientation:o,renderCoordsHelper:a});const u=s?.dimensionSegment??new x;return K({elevationAlignedStartPoint:t,elevationAlignedEndPoint:n})&&i===e.Vertical?(d(u.startRenderSpace,c.startRenderSpace),d(u.endRenderSpace,c.endRenderSpace)):N(u,l,r,c,a),new b(t,n,c,u,l,a.spatialReference)}function D(e,t,n,r){return t===M.Start?(d(e.startRenderSpace,n.startRenderSpace),d(e.endRenderSpace,r.startRenderSpace)):(d(e.startRenderSpace,n.endRenderSpace),d(e.endRenderSpace,r.endRenderSpace)),e}var M;function V(e,t,n,r){l(e.startRenderSpace,t.startRenderSpace,n,r),l(e.endRenderSpace,t.endRenderSpace,n,r)}function O(t,n,r,i){switch(n){case e.Direct:return B(t,r,i);case e.Horizontal:case e.Vertical:{const{elevationAlignedStartPoint:o,elevationAlignedEndPoint:a,dimension:s,geometry:d}=r;let c;if(s.measureType===e.Direct){c=I(d,i)===o.z>a.z,n===e.Horizontal&&(c=!c)}else c=!q(d);const[l,u]=c?[o,a]:[a,o],p=E(u,F);return n===e.Horizontal?p.z=l.z:(p.x=l.x,p.y=l.y),i.toRenderCoords(l,t.startRenderSpace),i.toRenderCoords(p,t.endRenderSpace),t}}}function B(e,t,n){return n.toRenderCoords(t.elevationAlignedStartPoint,e.startRenderSpace),n.toRenderCoords(t.elevationAlignedEndPoint,e.endRenderSpace),e}function I(e,t){const n=e.directSegment.eval(.5,h.get()),r=t.worldUpAtPosition(n,h.get()),i=e.dimensionSegment.eval(.5,h.get()),o=p(h.get(),i,n);return!g(o,A)&&S(o,r)>0}function q(e){const{startRenderSpace:t,endRenderSpace:n}=e.dimensionSegment,{startRenderSpace:r,endRenderSpace:i}=e.directSegment;return v(r,t)<v(i,n)}!function(e){e[e.Start=0]="Start",e[e.End=1]="End"}(M||(M={}));const F=j(0,0,0,null);function G(e,t,n,r){const{directSegment:i}=n,o=Y(h.get(),{measureType:t,directSegment:i,renderCoordsHelper:r}),a=N(L,o,0,i,r).eval(.5,h.get()),s=p(h.get(),e,a);return S(s,o)*r.unitInMeters}const L=new x;function Y(n,r){const{measureType:i,elevationAlignedStartPoint:o,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:c,endRenderSpace:l},directSegment:v,renderCoordsHelper:R}=r,P=v.eval(.5,h.get()),j=R.worldUpAtPosition(P,h.get()),E=R.worldBasisAtPosition(P,y.Y,h.get());switch(i){case e.Horizontal:d(n,j);break;case e.Vertical:S(c,j)<S(l,j)?p(n,l,c):p(n,c,l),m(n,n,j),m(n,n,j);break;case e.Direct:{const e=r.orientation??0;if(K({elevationAlignedStartPoint:o,elevationAlignedEndPoint:s}))a(J,-t(e),j),u(n,E,J);else{const r=p(h.get(),l,c),i=m(h.get(),r,j);m(i,i,r),a(J,t(e),r),u(n,i,J)}break}}return g(n,A)?d(n,E):f(n,n)}const J=s();function K({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}){return null!=e&&null!=t&&e.x===t.x&&e.y===t.y}function N(e,t,n,r,i){const{startRenderSpace:o,endRenderSpace:a}=r,s=n/i.unitInMeters,[d,c]=Q(o,a,t,s);return l(e.startRenderSpace,r.startRenderSpace,t,d),l(e.endRenderSpace,r.endRenderSpace,t,c),e}function Q(e,t,n,r=0){const i=S(t,n),o=S(e,n),a=Math.abs(i-o)+r;return i>o?[a,r]:[r,a]}function W(e,t,n){const r=t.directSegment.eval(.5,h.get());return n.worldUpAtPosition(r,e)}function X(e,t){const{startRenderSpace:n,endRenderSpace:r}=t.directSegment;return p(e,r,n)}function Z(e,t,n={invert:!1}){const{startRenderSpace:r,endRenderSpace:i}=t.dimensionSegment;return n.invert?p(e,r,i):p(e,i,r)}function $(e,t){const n=e.directSegment.eval(.5,h.get());return t.headingAtPosition(n,e.primaryOffsetAxis)}function _(e,t){return c(Z(ee,e))/t**2}const ee=R();function te(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:r}=e;if(null==t||null==r)return!1;const i=w(t,r);return null!=i&&n(i,"meters").value>U}function ne(e){return null!=e.geometry}export{b as LengthDimensionGeometry,M as OffsetSegmentLocation,K as arePointsVerticallyAligned,C as computationToGeometryDependencies,k as computeGeometryFromDimension,T as computeLength,Y as computeOffsetAxis,G as computeOffsetForPoint,O as computeSegmentForMeasureType,D as computeSpanningSegment,Z as dimensionStartToEnd,X as directStartToEnd,W as directUp,$ as headingFromGeometry,te as isGeodesicDimension,ne as isValidComputation,_ as maxScreenLengthSquaredFromGeometry,V as offsetSegment};
