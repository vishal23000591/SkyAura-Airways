/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../../../Graphic.js";import{isIterable as n}from"../../../core/iteratorUtils.js";import{screenPointObjectToArray as i,createScreenPointArray as r}from"../../../core/screenUtils.js";import{create as t}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import s from"../../../geometry/Point.js";import o from"../../../geometry/SpatialReference.js";import{projectVectorToVector as l}from"../../../geometry/projection/projectVectorToVector.js";import{fallbackObjectIDAttribute as c}from"../../../layers/LayerConstants.js";import{isIntegratedMeshLayer as a}from"../../../layers/support/layerUtils.js";import{debugFlags as u}from"./debugFlags.js";import{getElevationAtPoint as d}from"./ElevationProvider.js";import{Intersector as p}from"../webgl-engine/lib/Intersector.js";import{StoreResults as m}from"../webgl-engine/lib/IntersectorInterfaces.js";import{isValidIntersectorResult as f}from"../webgl-engine/lib/IntersectorResult.js";import{IntersectorType as g}from"../webgl-engine/lib/IntersectorType.js";import{toHit as y,toOwner as h}from"../webgl-engine/lib/intersectorUtilsConversions.js";import{terrainId as E}from"../webgl-engine/lib/verticalOffsetUtils.js";async function w(e,n,i,t){const s=i?R(e,i):t,o=r(n.x,n.y);s.requiresGroundFeedback=!0,s.enableDraped=!0;const l=new p(e.state.viewingMode);l.options.selectionMode=!0,l.options.store=m.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(o,l,s);const c=await U(e,l.results.all,s.graphics),d=l.results.ground,g=h(d,e),y=null!=g&&"type"in g&&a(g.type)?g:null,E={screenPoint:n,results:c,ground:{mapPoint:I(e,d),distance:f(d)?d.distanceInRenderSpace:0,layer:y}};return u.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(E.intersector=l),E}function b(e,n,r,t){const s=r?R(e,r):t,o=!(!s.graphics?.include&&!s.graphics?.exclude),l=!(!s.mediaElements?.include&&!s.mediaElements?.exclude),c=i(n);s.enableDraped=s.include&&!s.include.has(E)||s.exclude?.has(E);const a=e.sceneIntersectionHelper,u=new p(e.state.viewingMode);if(u.options.selectionMode=!0,u.options.store=o||l?m.ALL:m.MIN,u.options.excludeLabels=r?.excludeLabels??!1,a.intersectIntersectorScreen(c,u,s),o||l){for(const n of u.results.all){const i=y(n,e);if(null==i)return I(e,n);if(o&&("graphic"!==i.type||L(s.graphics,i.graphic)))return I(e,n);if(l&&("media"!==i.type||S(s.mediaElements,i.element)))return I(e,n)}return null}return I(e,u.results.min)}async function U(e,n,i){const r=new Array;let t,s=null;const o={defer(e){t=e()}};for(let l=0;l<n.length;l++){const c=n[l],u=h(c,e);if(null!=u&&(u===e.map.ground||"type"in u&&a(u.type)))break;const d=y(c,e,o)??await t;if(t=null,null==d)continue;if("graphic"===d.type){if(null==s&&l!==n.length-1&&(s=new Set),null!=s){const e=j(d.graphic);if(s.has(e))continue;s.add(e)}if(!L(i,d.graphic))continue}const p=I(e,c),m=c.distanceInRenderSpace;if("media"===d.type){const e=d.element.toSource(p);r.push({...d,mapPoint:p,distance:m,sourcePoint:e})}else r.push({...d,mapPoint:p,distance:m})}return r}function I(e,n,i){return n.getIntersectionPoint(N)?(i=x(e,N,i),n.intersector===g.TERRAIN&&e.basemapTerrain&&(i.z=d(e.basemapTerrain,i)??0),i):null}function j(e){const n=e.sourceLayer,i=e.layer,r=n&&"objectIdField"in n?n:i&&"objectIdField"in i?i:n;if(r){const n=r.objectIdField??c,i=e.attributes?.[n];if(i)return`o-${r.id}-${i}`}return`u-${e.uid}`}function L(e,n){return S(e,j(n))}function S(e,n){return null==e||(null==e.include||e.include.has(n))&&(null==e.exclude||!e.exclude.has(n))}function x(e,n,i){let r=e.spatialReference||o.WGS84;return l(n,e.renderSpatialReference,N,r)?n=N:(r=o.WGS84,l(n,e.renderSpatialReference,N,r)&&(n=N)),i?(i.x=n[0],i.y=n[1],i.z=n[2],i.spatialReference=r):i=new s(n,r),i}function R(e,n){const i=V(e,n.include,P.INCLUDE),r=V(e,n.exclude,P.EXCLUDE);return{include:i.layerViewUids,exclude:r.layerViewUids,graphics:{include:i.graphicUids,exclude:r.graphicUids},mediaElements:{include:i.mediaElements,exclude:r.mediaElements}}}function V(i,r,t,s={layerViewUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!r)return s;if(r instanceof e)T(s,j(r)),t===P.INCLUDE&&(null!=i.graphicsView&&r.layer===i?v(s,i.graphicsView.uid):r.layer&&C(s,i,r.layer.uid));else if("layer"in r&&"element"in r)D(s,r.element),t===P.INCLUDE&&C(s,i,r.layer.uid);else if(n(r))for(const e of r)e===i.graphics&&null!=i.graphicsView?v(s,i.graphicsView.uid):e===i.map.ground?v(s,E):V(i,e,t,s);else"uid"in r&&C(s,i,r.uid);return s}function C(e,n,i){const r=n.allLayerViews.find((e=>e.layer.uid===i));r&&v(e,r.uid)}function v(e,n){e.layerViewUids||(e.layerViewUids=new Set),e.layerViewUids.add(n)}function T(e,n){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(n)}function D(e,n){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(n)}const N=t();var P;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(P||(P={}));export{x as computeMapPointFromVec3d,R as externalToInternalIntersectOptions,j as getGraphicFilterUid,w as hitTest,I as intersectResultToMapPoint,b as toMap};
