/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import has from"../../../../../../../core/has.js";import t from"../../../../../../../core/workers/Connection.js";import{toQuantizationTransform as e}from"../../../../../../../geometry/support/quantizationUtils.js";import{convertFromFeatureSet as r,quantizeOptimizedFeatureSet as a}from"../../../../../../../layers/graphics/featureConversionUtils.js";import{queryOptimizedFeatureSet as s}from"../../../../../../../layers/ogc/ogcFeatureUtils.js";import{executeQueryPBFBuffer as i,executeQuery as o}from"../../../../../../../rest/query/operations/query.js";import{FeatureSetReaderJSON as n}from"../../../support/FeatureSetReaderJSON.js";import{FeatureSetReaderPBF as u}from"../../../support/FeatureSetReaderPBF.js";class c{constructor(t,e){this.service=t,this._metadata=e}destroy(){}}function m(t,e){switch(t.type){case"memory":return new f(t,e);case"ogc":return new y(t,e);case"feature-service":return t.queryMetadata.supportsFormatPBF&&has("featurelayer-pbf")?new l(t,e):new d(t,e)}}async function p(e){const r=new t;return await r.open(e,{}),r}class f extends c{constructor(t,e){super(t,e),this._portsOpen=p(t.source).then((t=>this.client=t))}destroy(){this.client.close(),this.client=null}async executeQuery(t,e){await this._portsOpen;const r=await this.client.invoke("queryFeatures",t.toJSON(),e);return n.fromFeatureSet(r,this._metadata)}}class l extends c{async executeQuery(t,e){const{data:r}=await i(this.service.source,t,e),a=!t.quantizationParameters;return u.fromBuffer(r,this._metadata,a)}}class d extends c{async executeQuery(t,s){const{source:i,queryMetadata:u}=this.service;if(null!=t.quantizationParameters&&!u.supportsQuantization){const u=t.clone(),c=e(u.quantizationParameters);u.quantizationParameters=null;const{data:m}=await o(i,u,this._metadata.spatialReference,s),p=r(m,this._metadata.featureIdInfo);return a(c,p),n.fromOptimizedFeatureSet(p,this._metadata)}const{data:c}=await o(i,t,this._metadata.spatialReference,s);return"esriGeometryPoint"===this._metadata.geometryType&&(c.features=c.features?.filter((t=>{if(null!=t.geometry){const e=t.geometry;return Number.isFinite(e.x)&&Number.isFinite(e.y)}return!0}))),n.fromFeatureSet(c,this._metadata)}}class y extends c{async executeQuery(t,r){if(t.quantizationParameters&&!this.service.queryMetadata.supportsQuantization){const i=t.clone(),o=e(i.quantizationParameters);i.quantizationParameters=null;const u=await s(this.service.source,t,r);return a(o,u),n.fromOptimizedFeatureSet(u,this._metadata)}const i=await s(this.service.source,t,r);return n.fromOptimizedFeatureSet(i,this._metadata)}}export{c as SourceAdapter,m as createQueryAdapter};
